<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Driver Auth Plus</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
*{box-sizing:border-box;margin:0;padding:0;font-family:'Poppins',sans-serif;}
body{
  height:100vh;display:flex;justify-content:center;align-items:center;
  background:linear-gradient(135deg,#0f2027,#203a43,#2c5364);
}
.authContainer{
  background: rgba(255,255,255,0.1);backdrop-filter: blur(15px);
  width:400px;border-radius:20px;overflow:hidden;box-shadow: 0 20px 40px rgba(0,0,0,0.5);position: relative;
}
.tabs{ display:flex; transition:0.5s; }
.tab{
  flex:1;text-align:center;padding:18px 0;font-weight:600;cursor:pointer;transition:0.3s;color:white;
}
.tab.active{ background: rgba(255,255,255,0.2); color:#fff; }
.formWrapper{
  padding:20px; transition:0.5s;
  position:relative;
}
input{
  width:100%;padding:12px 12px;margin:10px 0;border-radius:8px;border:none;outline:none;
  font-size:14px;background: rgba(255,255,255,0.2);color:white;
}
input::placeholder{ color: rgba(255,255,255,0.7);}
button{
  padding:12px;margin-top:10px;border:none;border-radius:8px;background:#007bff;color:white;font-weight:600;cursor:pointer;transition:0.3s;
}
button:hover{background:#0056b3;}
#photoPreview{
  width:100px;height:100px;border-radius:50%;margin:10px auto;object-fit:cover;
  box-shadow:0 4px 15px rgba(0,0,0,0.4);display:block;border:2px solid white;cursor:pointer;
}
.forgotBtn{background:#ffa500;margin-top:5px;}
.passwordToggle{position:absolute;right:20px;top:40px;cursor:pointer;color:white;}
</style>
</head>
<body>

<div class="authContainer">
  <div class="tabs">
    <div class="tab active" id="loginTab">Login</div>
    <div class="tab" id="registerTab">Register</div>
  </div>

  <!-- LOGIN FORM -->
  <div class="formWrapper" id="loginForm">
    <input type="email" id="loginEmail" placeholder="Email">
    <div style="position:relative;">
      <input type="password" id="loginPassword" placeholder="Password">
      <i class="fa fa-eye passwordToggle" id="toggleLoginPass"></i>
    </div>
    <button id="loginBtn">Login</button>
    <button class="forgotBtn" id="forgotBtn">Lupa Password</button>
  </div>

  <!-- REGISTER FORM -->
  <div class="formWrapper" id="registerForm" style="display:none;">
    <img id="photoPreview" src="https://via.placeholder.com/100" alt="Preview">
    <input type="file" accept="image/*" capture="environment" id="photoInput" style="display:none;">
    <input type="text" id="regName" placeholder="Nama Lengkap">
    <input type="text" id="regPhone" placeholder="Nomor Telepon">
    <input type="text" id="regPlate" placeholder="Plat Mobil">
    <input type="email" id="regEmail" placeholder="Email">
    <div style="position:relative;">
      <input type="password" id="regPassword" placeholder="Password">
      <i class="fa fa-eye passwordToggle" id="toggleRegPass"></i>
    </div>
    <button id="registerBtn">Register</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, push, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD3FQbFF5a91MlASpqImTMmGkYvaTcdxm0",
  authDomain: "kadek-ed34e.firebaseapp.com",
  databaseURL: "https://kadek-ed34e-default-rtdb.firebaseio.com",
  projectId: "kadek-ed34e",
  storageBucket: "kadek-ed34e.appspot.com",
  messagingSenderId: "65756136303",
  appId: "1:65756136303:web:6dbe5bc658fadb05ca1e9a"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// Tab switch
const loginTab = document.getElementById('loginTab');
const registerTab = document.getElementById('registerTab');
const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
loginTab.onclick = ()=>{ loginTab.classList.add('active'); registerTab.classList.remove('active'); loginForm.style.display='block'; registerForm.style.display='none'; }
registerTab.onclick = ()=>{ registerTab.classList.add('active'); loginTab.classList.remove('active'); registerForm.style.display='block'; loginForm.style.display='none'; }

// Toggle password
document.getElementById('toggleLoginPass').onclick = ()=> { const p=document.getElementById('loginPassword'); p.type=(p.type==='password')?'text':'password'; }
document.getElementById('toggleRegPass').onclick = ()=> { const p=document.getElementById('regPassword'); p.type=(p.type==='password')?'text':'password'; }

// Foto
const photoInput = document.getElementById('photoInput');
const photoPreview = document.getElementById('photoPreview');
let photoData="";
photoPreview.addEventListener('click',()=>photoInput.click());
photoInput.addEventListener('change', function(){
  const file = this.files[0];
  if(file){
    const reader = new FileReader();
    reader.onload = e=>{ photoData=e.target.result; photoPreview.src=photoData; }
    reader.readAsDataURL(file);
  }
});

// Register
document.getElementById('registerBtn').addEventListener('click', ()=>{
  const name=document.getElementById('regName').value.trim();
  const phone=document.getElementById('regPhone').value.trim();
  const plate=document.getElementById('regPlate').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const password=document.getElementById('regPassword').value.trim();
  if(!name||!phone||!plate||!email||!password){ alert("Semua field harus diisi!"); return; }

  const driversRef = ref(db,'drivers');
  onValue(driversRef,snapshot=>{
    const data=snapshot.val();
    let emailExists=false, phoneExists=false, plateExists=false;
    if(data){
      Object.values(data).forEach(d=>{
        if(d.email===email) emailExists=true;
        if(d.nomortelepon===phone) phoneExists=true;
        if(d.plate===plate) plateExists=true;
      });
    }
    if(emailExists){ alert("Email sudah terdaftar!"); return; }
    if(phoneExists){ alert("Nomor telepon sudah terdaftar!"); return; }
    if(plateExists){ alert("Plat mobil sudah terdaftar!"); return; }

    navigator.geolocation.getCurrentPosition(pos=>{
      const lat=pos.coords.latitude;
      const lng=pos.coords.longitude;
      const driverRef=push(driversRef);
      set(driverRef,{
        uid:driverRef.key,
        name, nomortelepon:phone, plate, email, password,
        photo:photoData, status:"Aktif",
        lat,lng,lastUpdate:Date.now()
      }).then(()=>{
        alert("Registrasi berhasil! Silakan login.");
        loginTab.click();
        document.getElementById('loginEmail').value=email;
        document.getElementById('loginPassword').value=password;
      });
    }, err=>alert("Gagal dapat lokasi: "+err.message));
  }, {onlyOnce:true});
});

// Login
document.getElementById('loginBtn').addEventListener('click', ()=>{
  const email=document.getElementById('loginEmail').value.trim();
  const password=document.getElementById('loginPassword').value.trim();
  if(!email||!password){ alert("Isi email & password!"); return; }

  const driversRef=ref(db,'drivers');
  onValue(driversRef,snapshot=>{
    const data=snapshot.val();
    let found=false;
    if(data){
      Object.entries(data).forEach(([key,driver])=>{
        if(driver.email===email && driver.password===password){
          found=true;
          if(driver.status!=="Aktif"){ alert("Akun tidak aktif!"); return; }

          // Simpan driverKey
          localStorage.setItem('driverKey', key);

          alert(`Login sukses! Selamat datang, ${driver.name}`);
          window.location.href="driver.html"; // redirect
        }
      });
      if(!found) alert("Email atau password salah!");
    } else alert("Belum ada driver terdaftar.");
  }, {onlyOnce:true});
});

// Lupa password
document.getElementById('forgotBtn').addEventListener('click', ()=>{
  const email=document.getElementById('loginEmail').value.trim();
  if(!email){ alert("Masukkan email untuk reset password"); return; }
  const driversRef=ref(db,'drivers');
  onValue(driversRef,snapshot=>{
    const data=snapshot.val();
    let found=false;
    if(data){
      Object.entries(data).forEach(([key,driver])=>{
        if(driver.email===email){
          found=true;
          const newPass=prompt("Masukkan password baru:");
          if(newPass) update(ref(db,'drivers/'+key),{password:newPass});
          alert("Password berhasil diubah!");
        }
      });
      if(!found) alert("Email tidak ditemukan!");
    }
  }, {onlyOnce:true});
});
</script>

</body>
</html>
